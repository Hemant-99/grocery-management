<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grocery Store - Billing System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --gray-color: #95a5a6;
            --text-color: #333;
            --light-bg: #f5f7fa;
            --white: #ffffff;
            --border-color: #ddd;
            --tap-highlight: rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: var(--tap-highlight);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding: 10px;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: var(--white);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            min-height: calc(100vh - 20px);
        }
        
        h1, h2, h3 {
            text-align: center;
            color: #2c3e50;
        }
        
        h1 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        h2 {
            margin-bottom: 12px;
            font-size: 1.3rem;
        }
        
        h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            -webkit-appearance: none;
            appearance: none;
        }
        
        button {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 48px;
        }
        
        button:active {
            transform: scale(0.98);
            background-color: var(--primary-hover);
        }
        
        button:disabled {
            opacity: 0.6;
            transform: none !important;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
            table-layout: fixed;
        }
        
        th, td {
            padding: 10px 5px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            word-break: break-word;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-buttons button {
            padding: 8px 10px;
            font-size: 0.8rem;
            width: auto;
            min-height: auto;
        }
        
        .edit-btn { 
            background-color: var(--warning-color);
        }
        .edit-btn:active {
            background-color: #e67e22;
        }
        
        .delete-btn { 
            background-color: var(--danger-color);
        }
        .delete-btn:active {
            background-color: #c0392b;
        }
        
        .logout-btn { 
            background-color: var(--gray-color);
            position: absolute;
            top: 15px;
            right: 15px;
            width: auto;
            padding: 8px 15px;
            font-size: 0.9rem;
            min-height: auto;
        }
        
        .error-message {
            color: var(--danger-color);
            margin: 10px 0;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .login-section, .signup-section {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }
        
        .app-header {
            margin-bottom: 15px;
            text-align: center;
            padding-top: 10px;
        }
        
        .welcome-message {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .store-name {
            font-size: 1rem;
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        /* Password validation styles */
        .password-strength {
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        .password-valid {
            color: var(--success-color);
        }
        
        .password-invalid {
            color: var(--danger-color);
        }
        
        .password-hint {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 3px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .unit-selector {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .unit-selector label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        .button-group button {
            flex: 1;
            min-height: 48px;
        }
        
        .search-container {
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: var(--white);
            padding: 10px 0;
            z-index: 10;
        }
        
        /* Billing System Styles */
        .billing-container {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 150px);
        }
        
        .billing-sidebar {
            width: 100%;
            background: #f8f9fa;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .billing-main {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .billing-btn {
            display: block;
            width: auto;
            padding: 12px 15px;
            margin-bottom: 0;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
            min-height: auto;
            flex-shrink: 0;
        }
        
        .billing-btn.active {
            background: #2980b9;
            font-weight: bold;
        }
        
        .bill-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .bill-total {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #333;
        }
        
        .bill-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .bill-actions button {
            flex: 1 1 120px;
            min-height: 48px;
        }
        
        .bill-history-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .bill-history-item h3 {
            text-align: left;
            margin-bottom: 5px;
        }
        
        .bill-history-item p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .bill-history-item button {
            margin-top: 8px;
            min-height: 40px;
        }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Success message */
        .success-message {
            color: var(--success-color);
            margin: 10px 0;
            font-size: 0.9rem;
            text-align: center;
            padding: 10px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 8px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            touch-action: manipulation;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        /* Customer details form */
        .customer-form {
            margin-top: 15px;
        }
        
        .customer-form input {
            margin-bottom: 12px;
        }
        
        /* Quantity input styles */
        .quantity-input {
            width: 60px !important;
            padding: 8px !important;
            margin: 0 5px !important;
            text-align: center;
            min-height: auto;
        }

        .stock-info {
            font-size: 0.8rem;
            color: #666;
            margin-left: 5px;
        }

        .out-of-stock {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Scrollable containers */
        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Bill items list */
        #billItemsList {
            max-height: 40vh;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Current bill items */
        #billItemsContainer {
            max-height: 30vh;
            overflow-y: auto;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Bill history container */
        #billHistoryContainer {
            max-height: 60vh;
            overflow-y: auto;
            margin-top: 10px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printSection, #printSection * {
                visibility: visible;
            }
            #printSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 10px;
                font-family: Arial, sans-serif;
                font-size: 12px;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 10px;
            }
            
            .print-store-name {
                font-size: 18px;
                font-weight: bold;
                margin-bottom: 3px;
            }
            
            .print-store-info {
                font-size: 12px;
                margin-bottom: 5px;
                color: #555;
            }
            
            .print-bill-details {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                font-size: 12px;
                border-bottom: 1px dashed #ccc;
                padding-bottom: 5px;
            }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
                font-size: 12px;
            }
            
            .print-table th {
                border-bottom: 2px solid #000;
                padding: 5px;
                text-align: left;
            }
            
            .print-table td {
                padding: 5px;
                border-bottom: 1px solid #ddd;
            }
            
            .print-total {
                text-align: right;
                font-weight: bold;
                margin-top: 10px;
                font-size: 14px;
                border-top: 2px solid #000;
                padding-top: 5px;
            }
            
            .print-footer {
                margin-top: 15px;
                text-align: center;
                font-size: 10px;
                color: #777;
                border-top: 1px dashed #ccc;
                padding-top: 5px;
            }
            
            .print-thank-you {
                margin-top: 10px;
                text-align: center;
                font-style: italic;
                font-size: 14px;
            }
            
            .print-customer {
                margin-top: 5px;
                font-size: 12px;
            }
        }

        /* Print Section (hidden) */
        #printSection {
            display: none;
        }

        /* Mobile Bill Popup Styles */
        .mobile-bill-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .mobile-bill-popup.hidden {
            display: none;
        }
        
        .mobile-bill-content {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        
        .mobile-bill-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            position: relative;
            text-align: center;
        }
        
        .mobile-bill-header h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: #333;
        }
        
        .mobile-bill-header p {
            margin: 0 0 5px 0;
            color: #666;
            font-size: 12px;
        }
        
        .mobile-bill-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .close-mobile-bill {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }
        
        .mobile-bill-body {
            padding: 15px;
        }
        
        .mobile-bill-customer {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        .mobile-bill-customer p {
            margin: 5px 0;
        }
        
        .mobile-bill-items {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .mobile-bill-items th {
            text-align: left;
            padding: 8px 5px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        
        .mobile-bill-items td {
            padding: 8px 5px;
            border-bottom: 1px dashed #eee;
        }
        
        .mobile-bill-items td:nth-child(2),
        .mobile-bill-items td:nth-child(3),
        .mobile-bill-items td:nth-child(4) {
            text-align: right;
        }
        
        .mobile-bill-footer {
            padding: 15px;
            border-top: 1px solid #eee;
        }
        
        .mobile-bill-total {
            text-align: right;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
            padding-top: 10px;
            border-top: 2px solid #333;
        }
        
        .mobile-bill-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .mobile-bill-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #printMobileBill {
            background-color: #3498db;
            color: white;
        }
        
        #closeMobileBill {
            background-color: #e74c3c;
            color: white;
        }
        
        .mobile-bill-thanks {
            text-align: center;
            font-style: italic;
            color: #666;
            font-size: 13px;
        }
        
        /* Admin Section Styles */
        .admin-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .admin-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .revenue-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .revenue-table th, .revenue-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .revenue-table th {
            background-color: #f2f2f2;
        }
        
        .admin-btn {
            background-color: #9b59b6;
            margin-top: 10px;
        }
        
        .admin-btn:active {
            background-color: #8e44ad;
        }
        
        @media (max-width: 480px) {
            .mobile-bill-content {
                font-size: 12px;
            }
            
            .mobile-bill-header h3 {
                font-size: 16px;
            }
            
            .mobile-bill-items th,
            .mobile-bill-items td {
                padding: 5px 3px;
            }
            
            .mobile-bill-total {
                font-size: 14px;
            }
            
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            h2 {
                font-size: 1.1rem;
            }
            
            input, select, button {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .billing-btn {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .bill-item {
                padding: 10px 8px;
                font-size: 0.9rem;
            }
            
            .action-buttons button {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
        .revenue-container {
            margin-top: 20px;
        }
        
        .revenue-day {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .revenue-day h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .revenue-stats {
            display: flex;
            justify-content: space-between;
        }
        
        .revenue-stat {
            text-align: center;
            flex: 1;
        }
        
        .revenue-stat span {
            font-size: 1.2rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .month-selector {
            margin-bottom: 15px;
        }
        
        .month-report {
            margin-top: 20px;
        }
        
        .report-error {
            color: #e74c3c;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection">
            <div class="login-section">
                <h1>Grocery Manager</h1>
                <h2>Login</h2>
                <div class="form-group">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <div id="loginPasswordFeedback" class="password-strength hidden"></div>
                </div>
                <button id="loginBtn">Login</button>
                <div id="loginSpinner" class="spinner hidden"></div>
                <p id="loginError" class="error-message hidden"></p>
                <p style="text-align: center; margin-top: 15px;">Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
            </div>
        </div>

        <!-- Signup Section -->
        <div id="signupSection" class="hidden">
            <div class="signup-section">
                <h1>Grocery Manager</h1>
                <h2>Create Account</h2>
                <div class="form-group">
                    <input type="email" id="signupEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signupPassword" placeholder="Password (min 8 chars)" required>
                    <div id="signupPasswordFeedback" class="password-strength hidden"></div>
                    <p class="password-hint">Password must be at least 8 characters with letters and numbers</p>
                </div>
                <div class="form-group">
                    <input type="text" id="storeName" placeholder="Your Store Name" required>
                </div>
                <div class="form-group">
                    <input type="text" id="storeAddress" placeholder="Store Address">
                </div>
                <div class="form-group">
                    <input type="tel" id="storePhone" placeholder="Store Phone Number">
                </div>
                <button id="signupBtn" disabled>Create Account</button>
                <div id="signupSpinner" class="spinner hidden"></div>
                <p id="signupError" class="error-message hidden"></p>
                <p style="text-align: center; margin-top: 15px;">Already have an account? <a href="#" id="showLogin">Login</a></p>
            </div>
        </div>

        <!-- App Section -->
        <div id="appSection" class="hidden">
            <button id="logoutBtn" class="logout-btn">Logout</button>
            <div class="app-header">
                <h1 class="welcome-message">Welcome back!</h1>
                <p class="store-name" id="storeNameDisplay"></p>
            </div>
            
            <div class="billing-container">
                <!-- Billing Sidebar -->
                <div class="billing-sidebar">
                    <button id="newBillBtn" class="billing-btn active">New Bill</button>
                    <button id="billHistoryBtn" class="billing-btn">Bill History</button>
                    <button id="inventoryBtn" class="billing-btn">Inventory</button>
                    <button id="adminBtn" class="billing-btn admin-btn">Admin</button>
                </div>
                
                <!-- Billing Main Content -->
                <div class="billing-main">
                    <!-- New Bill Section -->
                    <div id="newBillSection">
                        <h2>Create New Bill</h2>
                        <div class="search-container">
                            <input type="text" id="billSearchInput" placeholder="Search items..." autocomplete="off">
                        </div>
                        <div id="billItemsList" class="scrollable">
                            <!-- Items will be listed here -->
                        </div>
                        <div id="currentBillItems">
                            <h3>Current Bill</h3>
                            <div id="billItemsContainer" class="scrollable">
                                <!-- Bill items will appear here -->
                            </div>
                            <div class="bill-total">
                                Total: ₹<span id="billTotal">0.00</span>
                            </div>
                            <div class="bill-actions">
                                <button id="printBillBtn" class="billing-btn">Print Bill</button>
                                <button id="saveBillBtn" class="billing-btn">Save Bill</button>
                                <button id="clearBillBtn" class="billing-btn">Clear Bill</button>
                                <button id="addCustomerBtn" class="billing-btn">Add Customer</button>
                            </div>
                            <div id="customerDetails" class="hidden">
                                <h3>Customer Details</h3>
                                <div id="customerInfo"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bill History Section -->
                    <div id="billHistorySection" class="hidden">
                        <h2>Bill History</h2>
                        <div class="search-container">
                            <input type="text" id="historySearchInput" placeholder="Search bills..." autocomplete="off">
                        </div>
                        <div id="billHistoryContainer" class="scrollable">
                            <!-- Bill history will appear here -->
                        </div>
                    </div>
                    
                    <!-- Inventory Section -->
                    <div id="inventorySection" class="hidden">
                        <h2>Inventory Management</h2>
                        <div class="form-section">
                            <form id="groceryForm">
                                <input type="hidden" id="itemId">
                                <div class="form-group">
                                    <input type="text" id="itemName" placeholder="Item Name" required>
                                </div>
                                <div class="form-group">
                                    <input type="number" id="itemPrice" placeholder="Price" min="0.01" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <div class="unit-selector">
                                        <label><input type="radio" name="unit" value="kg" checked> per kg</label>
                                        <label><input type="radio" name="unit" value="L"> per L</label>
                                        <label><input type="radio" name="unit" value="piece"> per piece</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <input type="number" id="itemQuantity" placeholder="Quantity" min="0" required>
                                </div>
                                <div class="button-group">
                                    <button type="submit" id="saveBtn">Save Item</button>
                                    <button type="button" id="clearBtn">Clear Form</button>
                                </div>
                            </form>
                        </div>

                        <div class="search-container">
                            <input type="text" id="searchInput" placeholder="Search items..." autocomplete="off">
                        </div>

                        <div class="table-section">
                            <table id="groceryTable">
                                <thead>
                                    <tr>
                                        <th style="width: 15%;">ID</th>
                                        <th style="width: 25%;">Name</th>
                                        <th style="width: 20%;">Price</th>
                                        <th style="width: 15%;">Unit</th>
                                        <th style="width: 10%;">Qty</th>
                                        <th style="width: 15%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Admin Section -->
                    <div id="adminSection" class="hidden">
                        <h2>Admin Dashboard</h2>
                        
                        <div class="admin-section">
                            <h3>Store Information</h3>
                            <div class="form-group">
                                <input type="text" id="updateStoreName" placeholder="Store Name">
                            </div>
                            <div class="form-group">
                                <input type="text" id="updateStoreAddress" placeholder="Store Address">
                            </div>
                            <div class="form-group">
                                <input type="tel" id="updateStorePhone" placeholder="Store Phone">
                            </div>
                            <button id="updateStoreInfoBtn">Update Store Information</button>
                        </div>
                        
                        <div class="admin-section">
                            <h3>Daily Revenue</h3>
                            <div id="dailyRevenueContainer" class="revenue-container">
                                <!-- Daily revenue will be displayed here -->
                            </div>
                        </div>
                        
                        <div class="admin-section">
                            <h3>Monthly Report</h3>
                            <div class="month-selector">
                                <label for="reportMonth">Select Month:</label>
                                <input type="month" id="reportMonth">
                            </div>
                            <button id="generateReportBtn">Generate Report</button>
                            
                            <div id="monthReport" class="month-report hidden">
                                <h4>Monthly Revenue for <span id="reportMonthDisplay"></span></h4>
                                <div id="monthReportContent"></div>
                                <p id="reportError" class="report-error hidden"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add Customer Details</h2>
            <form id="customerForm" class="customer-form">
                <input type="text" id="customerName" placeholder="Customer Name" required>
                <input type="tel" id="customerPhone" placeholder="Phone Number">
                <input type="email" id="customerEmail" placeholder="Email">
                <button type="submit">Save Customer</button>
            </form>
        </div>
    </div>

    <!-- Mobile Bill Popup -->
    <div id="mobileBillPopup" class="mobile-bill-popup hidden">
        <div class="mobile-bill-content">
            <div class="mobile-bill-header">
                <h3 id="mobileBillStoreName"></h3>
                <p id="mobileBillStoreInfo"></p>
                <div class="mobile-bill-meta">
                    <span id="mobileBillDate"></span>
                    <span id="mobileBillTime"></span>
                </div>
                <button class="close-mobile-bill">&times;</button>
            </div>
            <div class="mobile-bill-body">
                <div id="mobileBillCustomer" class="mobile-bill-customer hidden"></div>
                <table class="mobile-bill-items">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="mobileBillItems">
                    </tbody>
                </table>
            </div>
            <div class="mobile-bill-footer">
                <div class="mobile-bill-total">
                    Total: ₹<span id="mobileBillTotal">0.00</span>
                </div>
                <div class="mobile-bill-actions">
                    <button id="printMobileBill">Print</button>
                    <button id="closeMobileBill">Close</button>
                </div>
                <div class="mobile-bill-thanks">
                    Thank you for shopping with us!
                </div>
            </div>
        </div>
    </div>

    <!-- Print Section (hidden) -->
    <div id="printSection" style="display: none;"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAm5g2CzYefVc8BH3TXA_u9srIl8BNmyR0",
            authDomain: "rk-store-5bf7a.firebaseapp.com",
            databaseURL: "https://rk-store-5bf7a-default-rtdb.firebaseio.com",
            projectId: "rk-store-5bf7a",
            storageBucket: "rk-store-5bf7a.appspot.com",
            messagingSenderId: "927163081383",
            appId: "1:927163081383:web:7e81ec1eab8511229d3182",
            measurementId: "G-2NN2BRFPMF"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // App state
        let currentUser = null;
        let groceryItems = [];
        let userStoreName = "";
        let userStoreAddress = "";
        let userStorePhone = "";
        let currentBill = [];
        let currentCustomer = null;
        let currentBillId = null;

        // DOM elements
        const loginSection = document.getElementById('loginSection');
        const signupSection = document.getElementById('signupSection');
        const appSection = document.getElementById('appSection');
        const showSignup = document.getElementById('showSignup');
        const showLogin = document.getElementById('showLogin');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const storeNameInput = document.getElementById('storeName');
        const storeAddressInput = document.getElementById('storeAddress');
        const storePhoneInput = document.getElementById('storePhone');
        const storeNameDisplay = document.getElementById('storeNameDisplay');
        const loginError = document.getElementById('loginError');
        const signupError = document.getElementById('signupError');
        const loginSpinner = document.getElementById('loginSpinner');
        const signupSpinner = document.getElementById('signupSpinner');

        // Billing elements
        const newBillBtn = document.getElementById('newBillBtn');
        const billHistoryBtn = document.getElementById('billHistoryBtn');
        const inventoryBtn = document.getElementById('inventoryBtn');
        const adminBtn = document.getElementById('adminBtn');
        const newBillSection = document.getElementById('newBillSection');
        const billHistorySection = document.getElementById('billHistorySection');
        const inventorySection = document.getElementById('inventorySection');
        const adminSection = document.getElementById('adminSection');
        const billSearchInput = document.getElementById('billSearchInput');
        const billItemsList = document.getElementById('billItemsList');
        const billItemsContainer = document.getElementById('billItemsContainer');
        const billTotal = document.getElementById('billTotal');
        const printBillBtn = document.getElementById('printBillBtn');
        const saveBillBtn = document.getElementById('saveBillBtn');
        const clearBillBtn = document.getElementById('clearBillBtn');
        const billHistoryContainer = document.getElementById('billHistoryContainer');
        const historySearchInput = document.getElementById('historySearchInput');
        const addCustomerBtn = document.getElementById('addCustomerBtn');
        const customerDetails = document.getElementById('customerDetails');
        const customerInfo = document.getElementById('customerInfo');
        const customerModal = document.getElementById('customerModal');
        const customerForm = document.getElementById('customerForm');
        const closeModal = document.querySelector('.close');

        // Inventory elements
        const form = document.getElementById('groceryForm');
        const tableBody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        const itemIdInput = document.getElementById('itemId');
        const itemNameInput = document.getElementById('itemName');
        const itemPriceInput = document.getElementById('itemPrice');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');

        // Admin elements
        const updateStoreName = document.getElementById('updateStoreName');
        const updateStoreAddress = document.getElementById('updateStoreAddress');
        const updateStorePhone = document.getElementById('updateStorePhone');
        const updateStoreInfoBtn = document.getElementById('updateStoreInfoBtn');
        const reportMonth = document.getElementById('reportMonth');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const revenueReport = document.getElementById('revenueReport');
        const reportMonthDisplay = document.getElementById('reportMonthDisplay');
        const revenueData = document.getElementById('revenueData');
        const totalBills = document.getElementById('totalBills');
        const totalRevenue = document.getElementById('totalRevenue');

        // Mobile bill popup elements
        const mobileBillPopup = document.getElementById('mobileBillPopup');

        // Password validation elements
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginPasswordFeedback = document.getElementById('loginPasswordFeedback');
        const signupPasswordInput = document.getElementById('signupPassword');
        const signupPasswordFeedback = document.getElementById('signupPasswordFeedback');

        // Event Listeners
        showSignup.addEventListener('click', (e) => {
            e.preventDefault();
            loginSection.classList.add('hidden');
            signupSection.classList.remove('hidden');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            signupSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
        });

        loginBtn.addEventListener('click', handleLogin);
        signupBtn.addEventListener('click', handleSignup);
        logoutBtn.addEventListener('click', handleLogout);

        // Password validation during typing
        signupPasswordInput.addEventListener('input', validateSignupPassword);
        loginPasswordInput.addEventListener('input', validateLoginPassword);
        storeNameInput.addEventListener('input', validateSignupForm);

        // Billing Event Listeners
        newBillBtn.addEventListener('click', () => showSection('newBill'));
        billHistoryBtn.addEventListener('click', () => showSection('billHistory'));
        inventoryBtn.addEventListener('click', () => showSection('inventory'));
        adminBtn.addEventListener('click', () => showSection('admin'));
        billSearchInput.addEventListener('input', renderBillItemsList);
        printBillBtn.addEventListener('click', printBill);
        saveBillBtn.addEventListener('click', saveBill);
        clearBillBtn.addEventListener('click', clearCurrentBill);
        addCustomerBtn.addEventListener('click', showCustomerModal);
        closeModal.addEventListener('click', () => customerModal.style.display = 'none');
        customerForm.addEventListener('submit', saveCustomerDetails);
        historySearchInput.addEventListener('input', loadBillHistory);

        // Inventory Event Listeners
        form.addEventListener('submit', handleFormSubmit);
        clearBtn.addEventListener('click', clearGroceryForm);
        searchInput.addEventListener('input', renderTable);

        // Admin Event Listeners
        updateStoreInfoBtn.addEventListener('click', updateStoreInfo);
        generateReportBtn.addEventListener('click', generateRevenueReport);

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === customerModal) {
                customerModal.style.display = 'none';
            }
            if (event.target === mobileBillPopup) {
                mobileBillPopup.classList.add('hidden');
            }
        });

        // Functions
        function validateSignupPassword() {
            const password = signupPasswordInput.value;
            const hasMinLength = password.length >= 8;
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const isValid = hasMinLength && hasLetter && hasNumber;
            
            if (password.length > 0) {
                signupPasswordFeedback.classList.remove('hidden');
                
                let feedback = [];
                if (!hasMinLength) feedback.push("at least 8 characters");
                if (!hasLetter) feedback.push("at least one letter");
                if (!hasNumber) feedback.push("at least one number");
                
                if (isValid) {
                    signupPasswordFeedback.textContent = "✓ Password is valid";
                    signupPasswordFeedback.className = "password-strength password-valid";
                } else {
                    signupPasswordFeedback.textContent = `✗ Needs ${feedback.join(", ")}`;
                    signupPasswordFeedback.className = "password-strength password-invalid";
                }
            } else {
                signupPasswordFeedback.classList.add('hidden');
            }
            validateSignupForm();
        }

        function validateLoginPassword() {
            const password = loginPasswordInput.value;
            
            if (password.length > 0) {
                loginPasswordFeedback.classList.remove('hidden');
                loginPasswordFeedback.textContent = "✓ Password entered";
                loginPasswordFeedback.className = "password-strength password-valid";
            } else {
                loginPasswordFeedback.classList.add('hidden');
            }
        }

        function validateSignupForm() {
            const passwordValid = signupPasswordInput.value.length >= 8 && 
                               /[a-zA-Z]/.test(signupPasswordInput.value) && 
                               /[0-9]/.test(signupPasswordInput.value);
            const storeNameValid = storeNameInput.value.trim().length > 0;
            const emailValid = document.getElementById('signupEmail').value.includes('@');
            
            signupBtn.disabled = !(passwordValid && storeNameValid && emailValid);
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError(loginError, "Please enter both email and password");
                return;
            }

            loginSpinner.classList.remove('hidden');
            loginBtn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    loadUserData();
                })
                .catch((error) => {
                    let errorMessage = "Login failed. Please try again.";
                    switch(error.code) {
                        case 'auth/user-not-found':
                            errorMessage = "No user found with this email.";
                            break;
                        case 'auth/wrong-password':
                            errorMessage = "Incorrect password.";
                            break;
                        case 'auth/invalid-email':
                            errorMessage = "Invalid email format.";
                            break;
                    }
                    showError(loginError, errorMessage);
                })
                .finally(() => {
                    loginSpinner.classList.add('hidden');
                    loginBtn.disabled = false;
                });
        }

        function handleSignup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const storeName = document.getElementById('storeName').value.trim();
            const storeAddress = document.getElementById('storeAddress').value.trim();
            const storePhone = document.getElementById('storePhone').value.trim();

            if (!email || !password || !storeName) {
                showError(signupError, "Please fill all required fields");
                return;
            }

            signupSpinner.classList.remove('hidden');
            signupBtn.disabled = true;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    // Initialize user's data structure
                    return database.ref('users/' + currentUser.uid).set({
                        storeName: storeName,
                        storeAddress: storeAddress || "123 Grocery Street, Cityville",
                        storePhone: storePhone || "(123) 456-7890",
                        groceries: {},
                        bills: {},
                        customers: {}
                    });
                })
                .then(() => {
                    userStoreName = storeName;
                    userStoreAddress = storeAddress || "123 Grocery Street, Cityville";
                    userStorePhone = storePhone || "(123) 456-7890";
                    loadUserData();
                })
                .catch((error) => {
                    let errorMessage = "Signup failed. Please try again.";
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = "Email already in use.";
                            break;
                        case 'auth/weak-password':
                            errorMessage = "Password is too weak.";
                            break;
                        case 'auth/invalid-email':
                            errorMessage = "Invalid email format.";
                            break;
                    }
                    showError(signupError, errorMessage);
                })
                .finally(() => {
                    signupSpinner.classList.add('hidden');
                    signupBtn.disabled = false;
                });
        }

        function handleLogout() {
            auth.signOut().then(() => {
                currentUser = null;
                groceryItems = [];
                userStoreName = "";
                userStoreAddress = "";
                userStorePhone = "";
                currentBill = [];
                currentCustomer = null;
                loginSection.classList.remove('hidden');
                appSection.classList.add('hidden');
                clearGroceryForm();
                renderTable();
            });
        }

        function loadUserData() {
            if (!currentUser) return;
            
            // Load store info
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    userStoreName = userData.storeName || "My Store";
                    userStoreAddress = userData.storeAddress || "123 Grocery Street, Cityville";
                    userStorePhone = userData.storePhone || "(123) 456-7890";
                    storeNameDisplay.textContent = userStoreName;
                    
                    // Set current month in report selector
                    const today = new Date();
                    const month = today.getMonth() + 1;
                    const year = today.getFullYear();
                    document.getElementById('reportMonth').value = 
                        `${year}-${month.toString().padStart(2, '0')}`;
                });
            
            // Load groceries
            database.ref('users/' + currentUser.uid + '/groceries').on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    // Convert object to array
                    groceryItems = Object.values(data);
                } else {
                    // Initialize empty array if no data exists
                    groceryItems = [];
                }
                
                renderTable();
                renderBillItemsList();
                loginSection.classList.add('hidden');
                signupSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                showSection('newBill'); // Default to new bill section
            }, (error) => {
                console.error("Error loading data:", error);
                showError(loginError, "Failed to load data");
            });
        }

        function saveUserData() {
            if (!currentUser) return;
            
            // Convert array to object with IDs as keys
            const itemsObject = {};
            groceryItems.forEach(item => {
                itemsObject[item.id] = item;
            });
            
            database.ref('users/' + currentUser.uid + '/groceries').set(itemsObject)
                .catch(error => {
                    console.error("Error saving data:", error);
                    showError(null, "Error saving data. Please try again.");
                });
        }

        function showSection(section) {
            newBillSection.classList.add('hidden');
            billHistorySection.classList.add('hidden');
            inventorySection.classList.add('hidden');
            adminSection.classList.add('hidden');
            
            newBillBtn.classList.remove('active');
            billHistoryBtn.classList.remove('active');
            inventoryBtn.classList.remove('active');
            adminBtn.classList.remove('active');
            
            switch(section) {
                case 'newBill':
                    newBillSection.classList.remove('hidden');
                    newBillBtn.classList.add('active');
                    renderBillItemsList();
                    renderCurrentBill();
                    break;
                case 'billHistory':
                    billHistorySection.classList.remove('hidden');
                    billHistoryBtn.classList.add('active');
                    loadBillHistory();
                    break;
                case 'inventory':
                    inventorySection.classList.remove('hidden');
                    inventoryBtn.classList.add('active');
                    break;
                case 'admin':
                    adminSection.classList.remove('hidden');
                    adminBtn.classList.add('active');
                    loadStoreInfo();
                    break;
            }
        }
        
        function renderBillItemsList() {
            const searchTerm = billSearchInput.value.toLowerCase();
            const filteredItems = groceryItems.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
            
            billItemsList.innerHTML = '';
            
            if (filteredItems.length === 0) {
                const noItems = document.createElement('div');
                noItems.className = 'bill-item';
                noItems.textContent = 'No items found';
                billItemsList.appendChild(noItems);
                return;
            }
            
            filteredItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'bill-item';
                
                const outOfStock = item.quantity <= 0;
                const stockClass = outOfStock ? 'out-of-stock' : '';
                
                itemElement.innerHTML = `
                    <div style="flex: 1;">
                        <span>${item.name} (₹${item.price}/${item.unit})</span>
                        <span class="stock-info ${stockClass}">${outOfStock ? 'Out of stock' : `Stock: ${item.quantity}`}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <input type="number" id="qty-${item.id}" 
                               value="1" min="1" max="${item.quantity}" 
                               class="quantity-input" ${outOfStock ? 'disabled' : ''}>
                        <button onclick="addToBill(${item.id})" ${outOfStock ? 'disabled' : ''}>Add</button>
                    </div>
                `;
                billItemsList.appendChild(itemElement);
            });
        }
        
        function addToBill(itemId) {
            const item = groceryItems.find(i => i.id === itemId);
            if (!item) return;
            
            // Get the quantity from the input field
            const qtyInput = document.getElementById(`qty-${itemId}`);
            let quantity = parseInt(qtyInput.value) || 1;
            
            // Validate quantity
            if (quantity <= 0) {
                quantity = 1;
                qtyInput.value = 1;
            }
            
            if (quantity > item.quantity) {
                alert(`Not enough stock! Only ${item.quantity} available.`);
                qtyInput.value = item.quantity;
                return;
            }
            
            const existingItem = currentBill.find(i => i.id === itemId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                currentBill.push({
                    ...item,
                    quantity: quantity
                });
            }
            
            // Update inventory quantity locally
            item.quantity -= quantity;
            
            renderCurrentBill();
            renderBillItemsList(); // Refresh the items list to show updated quantities
        }
        
        function renderCurrentBill() {
            billItemsContainer.innerHTML = '';
            let total = 0;
            
            if (currentBill.length === 0) {
                const emptyBill = document.createElement('div');
                emptyBill.className = 'bill-item';
                emptyBill.textContent = 'No items in bill';
                billItemsContainer.appendChild(emptyBill);
                billTotal.textContent = '0.00';
                return;
            }
            
            currentBill.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'bill-item';
                itemElement.innerHTML = `
                    <span>${item.name} (${item.quantity} ${item.unit} × ₹${item.price})</span>
                    <span>
                        ₹${itemTotal.toFixed(2)} 
                        <button onclick="removeFromBill(${index})">✕</button>
                    </span>
                `;
                billItemsContainer.appendChild(itemElement);
            });
            
            billTotal.textContent = total.toFixed(2);
        }
        
        function removeFromBill(index) {
            const item = currentBill[index];
            const inventoryItem = groceryItems.find(i => i.id === item.id);
            
            if (inventoryItem) {
                inventoryItem.quantity += item.quantity;
            }
            
            currentBill.splice(index, 1);
            renderCurrentBill();
            renderBillItemsList(); // Refresh the items list to show updated quantities
        }
        
        function clearCurrentBill() {
            if (currentBill.length === 0) return;
            
            if (confirm('Are you sure you want to clear the current bill?')) {
                // Return all quantities to inventory
                currentBill.forEach(billItem => {
                    const inventoryItem = groceryItems.find(i => i.id === billItem.id);
                    if (inventoryItem) {
                        inventoryItem.quantity += billItem.quantity;
                    }
                });
                
                currentBill = [];
                currentCustomer = null;
                customerDetails.classList.add('hidden');
                renderCurrentBill();
                renderBillItemsList(); // Refresh the items list to show updated quantities
            }
        }
        
        function showCustomerModal() {
            customerModal.style.display = 'block';
            document.getElementById('customerName').focus();
        }
        
        function saveCustomerDetails(e) {
            e.preventDefault();
            
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            
            if (!name) {
                alert("Please enter at least a customer name");
                return;
            }
            
            currentCustomer = {
                name,
                phone: phone || 'N/A',
                email: email || 'N/A'
            };
            
            customerInfo.innerHTML = `
                <p><strong>Name:</strong> ${name}</p>
                ${phone ? `<p><strong>Phone:</strong> ${phone}</p>` : ''}
                ${email ? `<p><strong>Email:</strong> ${email}</p>` : ''}
                <button onclick="editCustomer()" class="billing-btn" style="margin-top: 10px;">Edit</button>
            `;
            
            customerDetails.classList.remove('hidden');
            customerModal.style.display = 'none';
            customerForm.reset();
        }
        
        function editCustomer() {
            document.getElementById('customerName').value = currentCustomer.name;
            document.getElementById('customerPhone').value = currentCustomer.phone !== 'N/A' ? currentCustomer.phone : '';
            document.getElementById('customerEmail').value = currentCustomer.email !== 'N/A' ? currentCustomer.email : '';
            showCustomerModal();
        }
        
        function saveBill() {
            if (currentBill.length === 0) {
                alert("Cannot save an empty bill!");
                return;
            }
            
            // First update all inventory items in Firebase
            const updates = {};
            currentBill.forEach(billItem => {
                const inventoryItem = groceryItems.find(i => i.id === billItem.id);
                if (inventoryItem) {
                    updates[`/users/${currentUser.uid}/groceries/${billItem.id}/quantity`] = inventoryItem.quantity;
                }
            });
            
            // Show loading state
            saveBillBtn.disabled = true;
            saveBillBtn.textContent = "Saving...";
            
            // Perform all inventory updates at once
            database.ref().update(updates)
                .then(() => {
                    // After inventory is updated, save the bill
                    const billData = {
                        date: new Date().toISOString(),
                        items: currentBill,
                        total: parseFloat(billTotal.textContent),
                        storeName: userStoreName,
                        storeAddress: userStoreAddress,
                        storePhone: userStorePhone,
                        customer: currentCustomer || null
                    };
                    
                    return database.ref('users/' + currentUser.uid + '/bills').push().set(billData);
                })
                .then(() => {
                    // If customer exists, save them separately
                    if (currentCustomer) {
                        database.ref('users/' + currentUser.uid + '/customers').push({
                            ...currentCustomer,
                            lastPurchase: new Date().toISOString()
                        });
                    }
                    
                    showSuccess("Bill saved successfully!");
                    clearCurrentBill();
                    loadBillHistory();
                    
                    // Force refresh of inventory data
                    return database.ref('users/' + currentUser.uid + '/groceries').once('value');
                })
                .then((snapshot) => {
                    const data = snapshot.val();
                    groceryItems = data ? Object.values(data) : [];
                    renderTable();
                    renderBillItemsList();
                })
                .catch(error => {
                    console.error("Error saving bill:", error);
                    showError(null, "Error saving bill. Please try again.");
                    
                    // Revert local changes if save failed
                    currentBill.forEach(billItem => {
                        const inventoryItem = groceryItems.find(i => i.id === billItem.id);
                        if (inventoryItem) {
                            inventoryItem.quantity += billItem.quantity;
                        }
                    });
                    renderTable();
                    renderBillItemsList();
                })
                .finally(() => {
                    saveBillBtn.disabled = false;
                    saveBillBtn.textContent = "Save Bill";
                });
        }
        
        function loadBillHistory() {
            const searchTerm = historySearchInput.value.toLowerCase();
            
            database.ref('users/' + currentUser.uid + '/bills').once('value')
                .then(snapshot => {
                    const bills = snapshot.val();
                    billHistoryContainer.innerHTML = '';
                    
                    if (!bills) {
                        billHistoryContainer.innerHTML = '<p>No bill history found</p>';
                        return;
                    }
                    
                    Object.entries(bills).forEach(([id, bill]) => {
                        // Skip if search term doesn't match
                        if (searchTerm && 
                            !bill.storeName.toLowerCase().includes(searchTerm) &&
                            !(bill.customer && bill.customer.name.toLowerCase().includes(searchTerm))) {
                            return;
                        }
                        
                        const billElement = document.createElement('div');
                        billElement.className = 'bill-history-item';
                        billElement.innerHTML = `
                            <h3>Bill #${id.substring(0, 6)}</h3>
                            <p>Date: ${new Date(bill.date).toLocaleString()}</p>
                            <p>Total: ₹${bill.total.toFixed(2)}</p>
                            <p>Items: ${bill.items.length}</p>
                            ${bill.customer ? `<p>Customer: ${bill.customer.name}</p>` : ''}
                            <button onclick="viewBillDetails('${id}')">View Details</button>
                            <button onclick="reprintBill('${id}')">Reprint</button>
                        `;
                        billHistoryContainer.appendChild(billElement);
                    });
                    
                    if (billHistoryContainer.innerHTML === '') {
                        billHistoryContainer.innerHTML = '<p>No bills match your search</p>';
                    }
                });
        }
        
        function viewBillDetails(billId) {
            database.ref('users/' + currentUser.uid + '/bills/' + billId).once('value')
                .then(snapshot => {
                    const bill = snapshot.val();
                    showMobileBill(bill);
                });
        }
        
        function reprintBill(billId) {
            database.ref('users/' + currentUser.uid + '/bills/' + billId).once('value')
                .then(snapshot => {
                    const bill = snapshot.val();
                    printBillContent(bill);
                });
        }
        
        function printBill() {
            if (currentBill.length === 0) {
                alert("No items in bill to print!");
                return;
            }
            
            const billData = {
                date: new Date().toISOString(),
                items: currentBill,
                total: parseFloat(billTotal.textContent),
                storeName: userStoreName,
                storeAddress: userStoreAddress,
                storePhone: userStorePhone,
                customer: currentCustomer || null
            };
            
            showMobileBill(billData);
        }
        
        function showMobileBill(billData) {
            const popup = document.getElementById('mobileBillPopup');
            const storeName = document.getElementById('mobileBillStoreName');
            const storeInfo = document.getElementById('mobileBillStoreInfo');
            const billDate = document.getElementById('mobileBillDate');
            const billTime = document.getElementById('mobileBillTime');
            const customerInfo = document.getElementById('mobileBillCustomer');
            const billItems = document.getElementById('mobileBillItems');
            const billTotal = document.getElementById('mobileBillTotal');
            
            // Set store info
            storeName.textContent = billData.storeName || 'My Store';
            storeInfo.textContent = `${billData.storeAddress || ''} ${billData.storePhone ? `| ${billData.storePhone}` : ''}`;
            
            // Set date and time
            const now = billData.date ? new Date(billData.date) : new Date();
            billDate.textContent = now.toLocaleDateString();
            billTime.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Set customer info if available
            if (billData.customer) {
                customerInfo.innerHTML = `
                    <p><strong>Name:</strong> ${billData.customer.name}</p>
                    ${billData.customer.phone ? `<p><strong>Phone:</strong> ${billData.customer.phone}</p>` : ''}
                    ${billData.customer.email ? `<p><strong>Email:</strong> ${billData.customer.email}</p>` : ''}
                `;
                customerInfo.classList.remove('hidden');
            } else {
                customerInfo.classList.add('hidden');
            }
            
            // Clear previous items
            billItems.innerHTML = '';
            
            // Add items to bill
            if (billData.items && billData.items.length > 0) {
                billData.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.quantity}${item.unit}</td>
                        <td>₹${item.price.toFixed(2)}</td>
                        <td>₹${(item.price * item.quantity).toFixed(2)}</td>
                    `;
                    billItems.appendChild(row);
                });
            }
            
            // Set total
            billTotal.textContent = billData.total ? billData.total.toFixed(2) : '0.00';
            
            // Show popup
            popup.classList.remove('hidden');
            
            // Add event listeners to buttons
            document.getElementById('printMobileBill').onclick = function() {
                printBillContent(billData);
            };
            
            document.getElementById('closeMobileBill').onclick = function() {
                popup.classList.add('hidden');
            };
            
            document.querySelector('.close-mobile-bill').onclick = function() {
                popup.classList.add('hidden');
            };
        }
        
        function printBillContent(billData) {
            const printSection = document.getElementById('printSection');
            printSection.innerHTML = '';
            
            // Get current date and time
            const now = new Date(billData.date);
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let printContent = `
                <div style="font-family: Arial, sans-serif; max-width: 80mm; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <h2 style="margin: 5px 0; font-size: 18px;">${billData.storeName}</h2>
                        <p style="margin: 3px 0; font-size: 12px;">${billData.storeAddress}</p>
                        <p style="margin: 3px 0; font-size: 12px;">${billData.storePhone}</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-bottom: 10px; font-size: 12px;">
                        <div>Date: ${dateStr}</div>
                        <div>Time: ${timeStr}</div>
                    </div>
                    
                    ${billData.customer ? `<div style="margin-bottom: 10px; font-size: 12px;"><strong>Customer:</strong> ${billData.customer.name}</div>` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 10px;">
                        <thead>
                            <tr style="border-bottom: 1px solid #000;">
                                <th style="text-align: left; padding: 3px 0;">Item</th>
                                <th style="text-align: right; padding: 3px 0;">Qty</th>
                                <th style="text-align: right; padding: 3px 0;">Price</th>
                                <th style="text-align: right; padding: 3px 0;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            billData.items.forEach(item => {
                printContent += `
                    <tr style="border-bottom: 1px dashed #eee;">
                        <td style="padding: 3px 0;">${item.name}</td>
                        <td style="text-align: right; padding: 3px 0;">${item.quantity}${item.unit}</td>
                        <td style="text-align: right; padding: 3px 0;">₹${item.price.toFixed(2)}</td>
                        <td style="text-align: right; padding: 3px 0;">₹${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            printContent += `
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; border-top: 2px solid #000; padding-top: 5px; margin-top: 5px; font-weight: bold;">
                        Total: ₹${billData.total.toFixed(2)}
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px; font-style: italic;">
                        Thank you for shopping with us!
                    </div>
                    
                    <div style="text-align: center; font-size: 10px; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
                        Please retain this receipt for returns/exchanges
                    </div>
                </div>
            `;
            
            printSection.innerHTML = printContent;
            
            // Ensure print section is visible before printing
            printSection.style.display = 'block';
            
            // Trigger print after a small delay to ensure content is rendered
            setTimeout(() => {
                window.print();
                printSection.style.display = 'none';
                mobileBillPopup.classList.add('hidden');
            }, 100);
        }
        
        // Admin Functions
        function loadStoreInfo() {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    updateStoreName.value = userData.storeName || "";
                    updateStoreAddress.value = userData.storeAddress || "";
                    updateStorePhone.value = userData.storePhone || "";
                    
                    // Load daily revenue
                    loadDailyRevenue();
                });
        }

        function loadDailyRevenue() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            database.ref('users/' + currentUser.uid + '/dailyRevenue/' + todayStr).once('value')
                .then((snapshot) => {
                    const dailyData = snapshot.val();
                    displayDailyRevenue(today, dailyData);
                });
        }

        function displayDailyRevenue(date, dailyData) {
            const dailyRevenueContainer = document.getElementById('dailyRevenueContainer');
            dailyRevenueContainer.innerHTML = '';
            
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const revenueDay = document.createElement('div');
            revenueDay.className = 'revenue-day';
            
            if (dailyData) {
                revenueDay.innerHTML = `
                    <h4>${dateStr}</h4>
                    <div class="revenue-stats">
                        <div class="revenue-stat">
                            <div>Total Bills</div>
                            <span>${dailyData.totalBills || 0}</span>
                        </div>
                        <div class="revenue-stat">
                            <div>Total Revenue</div>
                            <span>₹${(dailyData.totalRevenue || 0).toFixed(2)}</span>
                        </div>
                        <div class="revenue-stat">
                            <div>Average Bill</div>
                            <span>₹${(dailyData.totalRevenue / dailyData.totalBills || 0).toFixed(2)}</span>
                        </div>
                    </div>
                `;
            } else {
                revenueDay.innerHTML = `
                    <h4>${dateStr}</h4>
                    <p>No revenue data for today yet</p>
                `;
            }
            
            dailyRevenueContainer.appendChild(revenueDay);
        }

        function generateRevenueReport() {
            const monthInput = document.getElementById('reportMonth').value;
            if (!monthInput) {
                showReportError("Please select a month");
                return;
            }
            
            const [year, month] = monthInput.split('-');
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            
            document.getElementById('reportMonthDisplay').textContent = 
                startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            // Clear previous error
            document.getElementById('reportError').classList.add('hidden');
            
            database.ref('users/' + currentUser.uid + '/bills').once('value')
                .then(snapshot => {
                    const bills = snapshot.val();
                    const monthReportContent = document.getElementById('monthReportContent');
                    monthReportContent.innerHTML = '';
                    
                    if (!bills) {
                        monthReportContent.innerHTML = '<p>No bills found for this month</p>';
                        document.getElementById('monthReport').classList.remove('hidden');
                        return;
                    }
                    
                    // Initialize daily totals
                    const dailyTotals = {};
                    let monthTotalBills = 0;
                    let monthTotalRevenue = 0;
                    
                    // Process each bill
                    Object.values(bills).forEach(bill => {
                        const billDate = new Date(bill.date);
                        if (billDate >= startDate && billDate <= endDate) {
                            const dateStr = billDate.toISOString().split('T')[0];
                            
                            if (!dailyTotals[dateStr]) {
                                dailyTotals[dateStr] = {
                                    bills: 0,
                                    revenue: 0
                                };
                            }
                            
                            dailyTotals[dateStr].bills++;
                            dailyTotals[dateStr].revenue += bill.total;
                            monthTotalBills++;
                            monthTotalRevenue += bill.total;
                        }
                    });
                    
                    // Sort dates chronologically
                    const sortedDates = Object.keys(dailyTotals).sort();
                    
                    // Display the report
                    if (sortedDates.length === 0) {
                        monthReportContent.innerHTML = '<p>No bills found for this month</p>';
                    } else {
                        // Create table for report
                        const table = document.createElement('table');
                        table.className = 'revenue-table';
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Bills</th>
                                    <th>Revenue</th>
                                    <th>Average</th>
                                </tr>
                            </thead>
                            <tbody>
                        `;
                        
                        // Add rows for each day
                        sortedDates.forEach(dateStr => {
                            const date = new Date(dateStr);
                            const dayData = dailyTotals[dateStr];
                            const avg = dayData.revenue / dayData.bills;
                            
                            table.innerHTML += `
                                <tr>
                                    <td>${date.toLocaleDateString()}</td>
                                    <td>${dayData.bills}</td>
                                    <td>₹${dayData.revenue.toFixed(2)}</td>
                                    <td>₹${avg.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        
                        // Add monthly totals
                        table.innerHTML += `
                            <tfoot>
                                <tr>
                                    <th>Monthly Total</th>
                                    <th>${monthTotalBills}</th>
                                    <th>₹${monthTotalRevenue.toFixed(2)}</th>
                                    <th>₹${(monthTotalRevenue / monthTotalBills || 0).toFixed(2)}</th>
                                </tr>
                            </tfoot>
                        `;
                        
                        table.innerHTML += `</tbody>`;
                        monthReportContent.appendChild(table);
                    }
                    
                    document.getElementById('monthReport').classList.remove('hidden');
                    
                    // Update daily revenue in database
                    updateDailyRevenue(startDate, monthTotalBills, monthTotalRevenue);
                })
                .catch(error => {
                    console.error("Error generating report:", error);
                    showReportError("Failed to generate report. Please try again.");
                });
        }

        function updateDailyRevenue(date, totalBills, totalRevenue) {
            const dateStr = date.toISOString().split('T')[0];
            const updates = {
                totalBills: totalBills,
                totalRevenue: totalRevenue,
                lastUpdated: new Date().toISOString()
            };
            
            database.ref('users/' + currentUser.uid + '/dailyRevenue/' + dateStr).update(updates)
                .then(() => {
                    console.log("Daily revenue updated successfully");
                })
                .catch(error => {
                    console.error("Error updating daily revenue:", error);
                });
        }

        function showReportError(message) {
            const errorElement = document.getElementById('reportError');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        // Modify saveBill function to update daily revenue
        function saveBill() {
            if (currentBill.length === 0) {
                alert("Cannot save an empty bill!");
                return;
            }
            
            // First update all inventory items in Firebase
            const updates = {};
            currentBill.forEach(billItem => {
                const inventoryItem = groceryItems.find(i => i.id === billItem.id);
                if (inventoryItem) {
                    updates[`/users/${currentUser.uid}/groceries/${billItem.id}/quantity`] = inventoryItem.quantity;
                }
            });
            
            // Show loading state
            saveBillBtn.disabled = true;
            saveBillBtn.textContent = "Saving...";
            
            // Get current date for daily revenue tracking
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const billTotalAmount = parseFloat(billTotal.textContent);
            
            // Perform all inventory updates at once
            database.ref().update(updates)
                .then(() => {
                    // After inventory is updated, save the bill
                    const billData = {
                        date: now.toISOString(),
                        items: currentBill,
                        total: billTotalAmount,
                        storeName: userStoreName,
                        storeAddress: userStoreAddress,
                        storePhone: userStorePhone,
                        customer: currentCustomer || null
                    };
                    
                    return database.ref('users/' + currentUser.uid + '/bills').push().set(billData);
                })
                .then(() => {
                    // If customer exists, save them separately
                    if (currentCustomer) {
                        database.ref('users/' + currentUser.uid + '/customers').push({
                            ...currentCustomer,
                            lastPurchase: new Date().toISOString()
                        });
                    }
                    
                    // Update daily revenue
                    return database.ref('users/' + currentUser.uid + '/dailyRevenue/' + todayStr).transaction((dailyData) => {
                        if (dailyData === null) {
                            return {
                                totalBills: 1,
                                totalRevenue: billTotalAmount,
                                lastUpdated: new Date().toISOString()
                            };
                        } else {
                            dailyData.totalBills = (dailyData.totalBills || 0) + 1;
                            dailyData.totalRevenue = (dailyData.totalRevenue || 0) + billTotalAmount;
                            dailyData.lastUpdated = new Date().toISOString();
                            return dailyData;
                        }
                    });
                })
                .then(() => {
                    showSuccess("Bill saved successfully!");
                    clearCurrentBill();
                    loadBillHistory();
                    loadDailyRevenue();
                    
                    // Force refresh of inventory data
                    return database.ref('users/' + currentUser.uid + '/groceries').once('value');
                })
                .then((snapshot) => {
                    const data = snapshot.val();
                    groceryItems = data ? Object.values(data) : [];
                    renderTable();
                    renderBillItemsList();
                })
                .catch(error => {
                    console.error("Error saving bill:", error);
                    showError(null, "Error saving bill. Please try again.");
                    
                    // Revert local changes if save failed
                    currentBill.forEach(billItem => {
                        const inventoryItem = groceryItems.find(i => i.id === billItem.id);
                        if (inventoryItem) {
                            inventoryItem.quantity += billItem.quantity;
                        }
                    });
                    renderTable();
                    renderBillItemsList();
                })
                .finally(() => {
                    saveBillBtn.disabled = false;
                    saveBillBtn.textContent = "Save Bill";
                });
        }
        
        // Inventory Management Functions
        function renderTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredItems = groceryItems.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.id.toString().includes(searchTerm)
            );
            
            tableBody.innerHTML = '';
            
            if (filteredItems.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center;">No items found</td>';
                tableBody.appendChild(row);
                return;
            }
            
            filteredItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>₹${item.price.toFixed(2)}/${item.unit}</td>
                    <td>${item.unit}</td>
                    <td>${item.quantity}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" data-id="${item.id}">Edit</button>
                        <button class="delete-btn" data-id="${item.id}">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editItem(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteItem(id);
                });
            });
        }
        
        function editItem(id) {
            const item = groceryItems.find(item => item.id === id);
            if (item) {
                itemIdInput.value = item.id;
                itemNameInput.value = item.name;
                itemPriceInput.value = item.price;
                itemQuantityInput.value = item.quantity;
                // Set the unit radio button
                document.querySelector(`input[name="unit"][value="${item.unit}"]`).checked = true;
                saveBtn.textContent = 'Update Item';
                itemNameInput.focus();
            }
        }
        
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                groceryItems = groceryItems.filter(item => item.id !== id);
                saveUserData();
                renderTable();
                if (parseInt(itemIdInput.value) === id) {
                    clearGroceryForm();
                }
            }
        }
        
        function clearGroceryForm() {
            form.reset();
            itemIdInput.value = '';
            saveBtn.textContent = 'Save Item';
            // Reset unit to default (kg)
            document.querySelector('input[name="unit"][value="kg"]').checked = true;
        }
        
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const id = itemIdInput.value ? parseInt(itemIdInput.value) : 0;
            const name = itemNameInput.value.trim();
            const price = parseFloat(itemPriceInput.value);
            const quantity = parseInt(itemQuantityInput.value);
            const unit = document.querySelector('input[name="unit"]:checked').value;
            
            if (!name || isNaN(price) || isNaN(quantity)) {
                alert('Please fill all fields with valid values');
                return;
            }
            
            if (price <= 0) {
                alert('Price must be greater than 0');
                return;
            }
            
            if (quantity < 0) {
                alert('Quantity cannot be negative');
                return;
            }
            
            if (id === 0) {
                // Add new item
                const newId = groceryItems.length > 0 ? 
                    Math.max(...groceryItems.map(item => item.id)) + 1 : 1;
                const newItem = {
                    id: newId,
                    name,
                    price,
                    unit,
                    quantity
                };
                groceryItems.push(newItem);
            } else {
                // Update existing item
                const index = groceryItems.findIndex(item => item.id === id);
                if (index !== -1) {
                    groceryItems[index] = { id, name, price, unit, quantity };
                }
            }
            
            saveUserData();
            renderTable();
            clearGroceryForm();
        }
        
        function showError(element, message) {
            if (!element) {
                // Create a temporary error display
                const tempError = document.createElement('div');
                tempError.className = 'error-message';
                tempError.textContent = message;
                tempError.style.position = 'fixed';
                tempError.style.top = '20px';
                tempError.style.left = '50%';
                tempError.style.transform = 'translateX(-50%)';
                tempError.style.zIndex = '1000';
                tempError.style.padding = '10px 20px';
                tempError.style.backgroundColor = '#f8d7da';
                tempError.style.border = '1px solid #f5c6cb';
                tempError.style.borderRadius = '8px';
                document.body.appendChild(tempError);
                
                setTimeout(() => {
                    tempError.remove();
                }, 3000);
                return;
            }
            
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 3000);
        }
        
        function showSuccess(message) {
            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = message;
            
            // Insert after the current bill items
            const parent = document.getElementById('currentBillItems');
            parent.insertBefore(successMsg, parent.querySelector('.bill-actions'));
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }
        
        // Check auth state when page loads
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserData();
            } else {
                currentUser = null;
                groceryItems = [];
                userStoreName = "";
                userStoreAddress = "";
                userStorePhone = "";
                currentBill = [];
                currentCustomer = null;
                loginSection.classList.remove('hidden');
                appSection.classList.add('hidden');
            }
        });
        
        // Expose functions to global scope for inline event handlers
        window.addToBill = addToBill;
        window.removeFromBill = removeFromBill;
        window.viewBillDetails = viewBillDetails;
        window.reprintBill = reprintBill;
        window.editCustomer = editCustomer;
    </script>
</body>
</html>
